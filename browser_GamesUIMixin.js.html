<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: browser/GamesUIMixin.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: browser/GamesUIMixin.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*Copyright (C) 2022 The Xanado Project https://github.com/cdot/Xanado
  License MIT. See README.md at the root of this distribution for full copyright
  and license information. Author Crawford Currie http://c-dot.co.uk*/
/* eslint-env browser, jquery */

define([
  "browser/BrowserPlayer", "browser/BrowserGame", "browser/Dialog"
], (
  Player, Game, Dialog
) => {

  /**
   * Functionality shared between the client/server and standalone
   * versions of the Games UI
   * @mixin browser/GamesUIMixin
   */
  return superclass => class GamesUIMixin extends superclass {

    /**
     * Format of rows in the games table.
     * See {@linkcode browser/BrowserGame#headline}
     */
    static GAME_TABLE_ROW = '&lt;tr class="game" id="%k">'
    + '&lt;td class="h-key">%k&lt;/td>'
    + '&lt;td class="h-edition">%e&lt;/td>'
    + '&lt;td class="h-players">%p&lt;/td>'
    + '&lt;td class="h-last-play">%l&lt;/td>'
    + '&lt;td class="h-state">%s&lt;/td>'
    + '&lt;/tr>';

    /**
     * Attach event handlers to objects in the UI
     * @instance
     * @memberof browser/GamesUIMixin
     */
    attachUIEventHandlers() {
      super.attachUIEventHandlers();

      $("#showAllGames")
      .on("change", () => this.refreshGames());
    }

    /**
     * Used by GameDialog
     * @instance
     * @memberof browser/GamesUIMixin
     */
    gameOptions(game) {
      assert.fail("GamesUIMixin.gameOptions");
    }

    /**
     * Used by GameDialog
     * @instance
     * @memberof browser/GamesUIMixin
     */
    joinGame(game) {
      assert.fail("GamesUIMixin.joinGame");
    }

    /**
     * Used by GameDialog
     * @instance
     * @memberof browser/GamesUIMixin
     */
    addRobot(game) {
      assert.fail("GamesUIMixin.addRobot");
    }

    /**
     * Used by GameDialog
     * @instance
     * @memberof browser/GamesUIMixin
     */
    invitePlayers(game) {
      assert.fail("GamesUIMixin.invitePlayers");
    }

    /**
     * Used by GameDialog
     * @instance
     * @memberof browser/GamesUIMixin
     */
    anotherGame(game) {
      assert.fail("GamesUIMixin.anotherGame");
    }

    /**
     * Used by GameDialog
     * @instance
     * @memberof browser/GamesUIMixin
     */
    deleteGame(game) {
      assert.fail("GamesUIMixin.deleteGame");
    }

    /**
     * Used by GameDialog
     * @instance
     * @memberof browser/GamesUIMixin
     */
    observe(game) {
      assert.fail("GamesUIMixin.observe");
    }

    /**
     * @override
     * @instance
     * @memberof browser/GamesUIMixin
     */
    readyToListen() {
      return this.refresh();
    }

    /**
     * Construct a table row that shows the state of the given player
     * @instance
     * @memberof browser/GamesUIMixin
     * @param {Game|object} game a Game or Game.simple
     * @param {Player} player the player
     * @param {boolean} isActive true if the game isn't over
     */
    $player(game, player, isActive) {
      assert(player instanceof Player, "Not a player");
      const $tr = player.$tableRow();

      if (isActive) {
        if (player.dictionary &amp;&amp; player.dictionary !== game.dictionary) {
          const dic = $.i18n("using-dic", player.dictionary);
          $tr.append(`&lt;td>${dic}&lt;/td>`);
        }

        if (game.timerType &amp;&amp; player.clock) {
          const left = $.i18n("left-to-play", player.clock);
          $tr.append(`&lt;td>${left}&lt;/td>`);
        }

      } else {
        const winningScore = game.getPlayers().reduce(
          (max, p) =>
          Math.max(max, p.score), 0);

        if (player.score === winningScore) {
          $tr.append('&lt;td class="ui-icon icon-winner">&lt;/td>');
        }

        return $tr;
      }

      const $box = $(document.createElement("td"));
      $box.addClass("button-box");
      $tr.append($box);

      if (player.key === this.session.key) {
        // Currently signed in player
        $box.append(
          $(document.createElement("button"))
          .attr("name", `join${game.key}`)
          .button({ label: $.i18n("Open game") })
          .tooltip({
            content: $.i18n("tt-open")
          })
          .on("click", () => {
            console.debug(`Open game ${game.key}/${this.session.key}`);
            this.joinGame(game);
          }));
      }
      return $tr;
    }

    /**
     * Construct a table row that shows the state of the given game
     * @instance
     * @memberof browser/GamesUIMixin
     * @param {Game|object} game a Game or Game.simple
     * @private
     */
    $gameTableRow(game) {
      assert(game instanceof Game, "Not a game");
      return $(game.tableRow(this.constructor.GAME_TABLE_ROW))
      .on("click", () => {
        Dialog.open("browser/GameDialog", {
          game: game,
          ui: this
        });
      });
    }

    /**
     * Refresh the display of a single game
     * @instance
     * @memberof browser/GamesUIMixin
     * @param {Game|object} game a Game or Game.simple
     * @private
     */
    showGame(game) {
      // Update the games list and dialog headlines as appropriate
      $(`#${game.key}`).replaceWith(
        game.tableRow(this.constructor.GAME_TABLE_ROW));
      // Update the dialog if appropriate
      $(`#GameDialog[name=${game.key}]`)
      .data("this")
      .populate(game);
    }

    /**
     * Refresh the display of all games
     * @instance
     * @memberof browser/GamesUIMixin
     * @param {object[]} games array of Game.simple
     */
    showGames(simples) {
      if (simples.length === 0) {
        $("#gamesList").hide();
        return;
      }

      const $gt = $("#gamesList > tbody");
      $gt.empty();

      const games = simples.map(simple => Game.fromSerialisable(simple, Game))
            .sort((a, b) => a.creationTimestamp &lt; b.creationTimestamp ? -1 :
                  a.creationTimestamp > b.creationTimestamp ? 1 : 0);

      games.forEach(game => $gt.append(this.$gameTableRow(game)));

      $("#gamesList").show();
    }

    /**
     * Request an update for all games in a games table
     * @instance
     * @memberof browser/GamesUIMixin
     * @param {boolean?} noPlayers true to omit players from the
     * table headline
     */
    refreshGames() {
      const what = $("#showAllGames").is(":checked") ? "all" : "active";
      return this.getGames(what)
      .then(games => this.showGames(games))
      .catch(this.constructor.report);
    }

    /**
     * Request an update for a single game (which must exist in the
     * games table)
     * @instance
     * @memberof browser/GamesUIMixin
     * @param {string} key Game key
     */
    refreshGame(key) {
      return this.getGame(key)
      .then(simple => this.showGame(
        Game.fromSerialisable(simple[0], Game)))
      .catch(this.constructor.report);
    }

    /**
     * Request an update for session status and all games lists
     * @instance
     * @memberof browser/GamesUIMixin
     * @return {Promise} promise that resolves when all AJAX calls
     * have completed
     */
    refresh() {
      console.debug("refresh");
      return Promise.all([
        this.getSession()
        .then(session => {
          if (session) {
            $("#create-game").show();
            $("#chpw_button").toggle(session.provider === "xanado");
          } else {
            $("#create-game").hide();
          }
        })
        .then(() => this.refreshGames()),

        this.getHistory()
        .then(data => {
          if (data.length === 0) {
            $("#gamesCumulative").hide();
            return;
          }
          let n = 1;
          $("#gamesCumulative").show();
          const $gt = $("#playerList");
          $gt.empty();
          data.forEach(player => {
            const s = $.i18n(
              "leader-board-row", n++, player.name, player.score,
              player.games, player.wins);
            $gt.append(`&lt;div class="player-cumulative">${s}&lt;/div>`);
          });
        })
      ]);
    }

    /**
     * Get a list of games
     * @instance
     * @memberof browser/GamesUIMixin
     * @param {string} what 'all' or 'active' (default)
     * @return {Promise} resolves to a list of objects, one per
     * unique player, each with keys as follows:
     * * key: player key
     * * name: player name
     * * score: total cumulative score
     * * wins: number of wins
     * * games: number of games played
     */
    getHistory(what) {
      assert.fail("GamesUIMixin.getHistory");
    }

    /**
     * Get a list of games
     * @instance
     * @memberof browser/GamesUIMixin
     * @param {string} what `all` or `active`
     * @return {Promise} resolves to a list of Game.simple
     */
    getGames(what) {
      assert.fail("GamesUIMixin.getGames");
    }

    /**
     * Get the given game
     * @instance
     * @memberof browser/GamesUIMixin
     * @return {Promise} promise that resolves to a Game or Game.simple
     */
    getGame(key) {
      assert.fail("GamesUIMixin.getGame");
    }
  };
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BackendGame.html">BackendGame</a></li><li><a href="Board.html">Board</a></li><li><a href="BrowserBoard.html">BrowserBoard</a></li><li><a href="BrowserDatabase.html">BrowserDatabase</a></li><li><a href="BrowserGame.html">BrowserGame</a></li><li><a href="BrowserPlatform.html">BrowserPlatform</a></li><li><a href="BrowserPlayer.html">BrowserPlayer</a></li><li><a href="BrowserRack.html">BrowserRack</a></li><li><a href="BrowserTile.html">BrowserTile</a></li><li><a href="Channel.html">Channel</a></li><li><a href="ClientGamesUI.html">ClientGamesUI</a></li><li><a href="ClientGameUI.html">ClientGameUI</a></li><li><a href="Compressor.html">Compressor</a></li><li><a href="Configurator.html">Configurator</a></li><li><a href="Dialog.html">Dialog</a></li><li><a href="Dictionary.html">Dictionary</a></li><li><a href="Edition.html">Edition</a></li><li><a href="Explorer.html">Explorer</a></li><li><a href="FileDatabase.html">FileDatabase</a></li><li><a href="Fridge.html">Fridge</a></li><li><a href="Game.html">Game</a></li><li><a href="GameDialog.html">GameDialog</a></li><li><a href="GameSetupDialog.html">GameSetupDialog</a></li><li><a href="InvitePlayersDialog.html">InvitePlayersDialog</a></li><li><a href="JSAnalyser.html">JSAnalyser</a></li><li><a href="LetterBag.html">LetterBag</a></li><li><a href="LetterNode.html">LetterNode</a></li><li><a href="LoginDialog.html">LoginDialog</a></li><li><a href="Move.html">Move</a></li><li><a href="Player.html">Player</a></li><li><a href="Rack.html">Rack</a></li><li><a href="Server.html">Server</a></li><li><a href="ServerPlatform.html">ServerPlatform</a></li><li><a href="Square.html">Square</a></li><li><a href="StandaloneGamesUI.html">StandaloneGamesUI</a></li><li><a href="StandaloneGameUI.html">StandaloneGameUI</a></li><li><a href="Surface.html">Surface</a></li><li><a href="Tile.html">Tile</a></li><li><a href="Trie.html">Trie</a></li><li><a href="TrieNode.html">TrieNode</a></li><li><a href="Turn.html">Turn</a></li><li><a href="UI.html">UI</a></li><li><a href="UserManager.html">UserManager</a></li><li><a href="XanadoPass.html">XanadoPass</a></li></ul><h3>Interfaces</h3><ul><li><a href="Database.html">Database</a></li><li><a href="Platform.html">Platform</a></li></ul><h3>Mixins</h3><ul><li><a href="browser_GamesUIMixin.html">browser/GamesUIMixin</a></li><li><a href="browser_GameUIMixin.html">browser/GameUIMixin</a></li><li><a href="browser_SquareMixin.html">browser/SquareMixin</a></li><li><a href="browser_SurfaceMixin.html">browser/SurfaceMixin</a></li><li><a href="client_ClientUIMixin.html">client/ClientUIMixin</a></li><li><a href="client_PasswordMixin.html">client/PasswordMixin</a></li><li><a href="game_Commands.html">game/Commands</a></li><li><a href="game_Replay.html">game/Replay</a></li><li><a href="game_Undo.html">game/Undo</a></li><li><a href="standalone_StandaloneUIMixin.html">standalone/StandaloneUIMixin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#backend/findBestPlay">backend/findBestPlay</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Fri Dec 09 2022 15:51:54 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
