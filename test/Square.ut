/* See README.md at the root of this distribution for copyright and
   license information */
/* eslint-env node, mocha */
/*global document:writable*/

requirejs = require('requirejs');

requirejs.config({
    baseUrl: `${__dirname}/..`,
	nodeRequire: require,
    paths: {
		"jquery-ui": "node_modules/jquery-ui-dist/jquery-ui",
		common: "js/common",
		game: "js/game",
		dawg: "js/dawg",
		platform: "js/server/ServerPlatform"
    }
});

/**
 * Unit tests for Square class
 */
describe("Square class", () => {

	// node.js
	const { JSDOM } = require('jsdom');
	const document = new JSDOM('<!doctype html><html><body id="working"></body></html>');
	const { window } = document;
	global.window = window;
	global.document = window.document;
	global.navigator = { userAgent: "node.js" };
	const jQuery = require('jquery');
	global.jQuery = jQuery;
	global.$ = jQuery;

	const deps = [
		{ Square: "game/Square" },
		{ Tile: "game/Tile" },
		{ jQueryUI: "jquery-ui" }
	];
	
	const Assert = require("./Assert.js");
	before(required => {
		// Why? No idea, except without it, it won't work in
		// npm run
		global.document = window.document;
		return Assert.depend(required, deps);
	});

	it('construct', () => {
		let sq = new Square('q', { id: 'base' }, 56, 42);
		assert.equal(sq.letterScoreMultiplier, 4);
		assert.equal(sq.wordScoreMultiplier, 1);
		assert(!sq.tile);
		assert(!sq.tileLocked);
		assert(sq.isEmpty());
		let tile = new Tile({
			letter:'S', isBlank:false, score:1, col: 7, row: 7});
		tile.toString();
		sq.placeTile(tile, false);
		assert.strictEqual(sq.tile, tile);
		assert(!sq.tileLocked);
		assert(!sq.isEmpty());
		assert.equal(tile.col, sq.col);
		assert.equal(tile.row, sq.row);

		sq.placeTile();
		assert(!sq.tile);
		assert(!sq.tileLocked);
		assert(sq.isEmpty());

		sq.placeTile(tile, true);
		assert.strictEqual(sq.tile, tile);
		assert(sq.tileLocked);
		assert(!sq.isEmpty());
		assert.equal(tile.col, sq.col);
		assert.equal(tile.row, sq.row);
		assert.equal(new Square('Q', { id: 'base' }).letterScoreMultiplier, 1);
		assert.equal(new Square('Q', { id: 'base' }).wordScoreMultiplier, 4);

		assert.equal(new Square('t', { id: 'base' }).letterScoreMultiplier, 3);
		assert.equal(new Square('t', { id: 'base' }).wordScoreMultiplier, 1);
		assert.equal(new Square('T', { id: 'base' }).letterScoreMultiplier, 1);
		assert.equal(new Square('T', { id: 'base' }).wordScoreMultiplier, 3);

		assert.equal(new Square('d', { id: 'base' }).letterScoreMultiplier, 2);
		assert.equal(new Square('d', { id: 'base' }).wordScoreMultiplier, 1);
		assert.equal(new Square('D', { id: 'base' }).letterScoreMultiplier, 1);
		assert.equal(new Square('D', { id: 'base' }).wordScoreMultiplier, 2);
		assert.equal(new Square('M', { id: 'base' }).letterScoreMultiplier, 1);
		assert.equal(new Square('M', { id: 'base' }).wordScoreMultiplier, 2);
	});
	
	it('$ui', () => {
		let sq = new Square('q', { id: 'base' }, 56, 42);
		assert.equal(sq.$ui().html(),
					 '<div id="base_56x42"><a></a></div>');
		sq = new Square('_', { id: 'base' }, 56);
		assert.equal(sq.$ui().html(),
					 '<div id="base_56"><a></a></div>');
		$("body").empty();
	});

	it("refresh empty", () => {
		let sq = new Square('q', { id: 'base' }, 56, 42);
		sq.setUnderlay('T');
		let $td = sq.$ui();
		$("body").append($td);
		sq.$refresh();
		//console.log($("body").html());
		assert($td.hasClass("square-q"));
		const $div = $td.find("#base_56x42");
		assert($div.hasClass("empty-square"));
		assert($div.hasClass("ui-droppable"));
		assert.equal($div.find("A").text(), "square-q");
		const $u = $("#base_56x42 > div.underlay");
		assert($u.hasClass("underlay"));
		assert.equal($u.text(), "T");
		$("body").empty();
	});
	
	it("refresh occupied unlocked", () => {
		let sq = new Square('q', { id: 'surface' }, 56, 42);
		sq.setUnderlay('T');
		assert(!sq.tileLocked);
		let tile = new Tile({ letter:'S', isBlank:false });
		sq.placeTile(tile, false);
		assert(!sq.tileLocked);
		let $td = sq.$ui();
		$("body").append($td);
		sq.$refresh();
		sq.setSelected(true);
		//console.log($("body").html());
		assert($td.hasClass("square-q"));
		const $div = $("div[id=surface_56x42]");
		assert($div.hasClass("selected"));
		assert(!$div.hasClass("Locked"));
		assert($div.hasClass("tiled-square"));
		assert(!$div.hasClass("ui-droppable"));
		let $letter = $("#surface_56x42>a>span.letter");
		assert.equal($letter.text(), "S");
		let $score = $("#surface_56x42>a>span.score");
		assert.equal($score.text(), "0");
		sq.setSelected(false);
		assert(!$div.hasClass("selected"));
		assert.equal($("div.underlay").length, 0);

		sq.placeTile();
		tile = new Tile({ letter:'Q', isBlank:true });
		sq.placeTile(tile, false);
		sq.$refresh();
		assert($div.hasClass("blank-letter"));

		$("body").empty();
	});
	
	it("refresh occupied locked", () => {
		let sq = new Square('q', { id: 'surface' }, 56, 42);
		assert(!sq.tileLocked);
		let tile = new Tile({ letter:'S', isBlank:false });
		sq.placeTile(tile, true);
		assert(sq.tileLocked);
		let $td = sq.$ui();
		$("body").append($td);
		sq.$refresh();
		//console.log($("body").html());
		assert($td.hasClass("square-q"));
		const $div = $("div[id=surface_56x42]");
		assert(!$div.hasClass("selected"));
		assert($div.hasClass("Locked"));
		assert($div.hasClass("tiled-square"));
		assert(!$div.hasClass("ui-droppable"));
		let $letter = $("#surface_56x42>a>span.letter");
		assert.equal($letter.text(), "S");
		let $score = $("#surface_56x42>a>span.score");
		assert.equal($score.text(), "0");
		sq.setSelected(false);
		assert(!$div.hasClass("selected"));
		$("body").empty();
	});
});

